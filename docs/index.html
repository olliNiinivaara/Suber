<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- CSS -->
<title>suber</title>
<link rel="stylesheet" type="text/css" href="nimdoc.out.css">

<script type="text/javascript" src="dochack.js"></script>

<script type="text/javascript">
function main() {
  var pragmaDots = document.getElementsByClassName("pragmadots");
  for (var i = 0; i < pragmaDots.length; i++) {
    pragmaDots[i].onclick = function(event) {
      // Hide tease
      event.target.parentNode.style.display = "none";
      // Show actual
      event.target.parentNode.nextElementSibling.style.display = "inline";
    }
  }

  const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
  function switchTheme(e) {
      if (e.target.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
      } else {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
      }
  }

  toggleSwitch.addEventListener('change', switchTheme, false);

  const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;
  if (currentTheme) {
    document.documentElement.setAttribute('data-theme', currentTheme);

    if (currentTheme === 'dark') {
      toggleSwitch.checked = true;
    }
  }
}
</script>

</head>
<body onload="main()">
<div class="document" id="documentId">
  <div class="container">
    <h1 class="title">suber</h1>
    <div class="row">
  <div class="three columns">
  <div class="theme-switch-wrapper">
    <label class="theme-switch" for="checkbox">
      <input type="checkbox" id="checkbox" />
      <div class="slider round"></div>
    </label>
    &nbsp;&nbsp;&nbsp; <em>Dark Mode</em>
  </div>
  <div id="global-links">
    <ul class="simple">
    <li>
      <a href="theindex.html">Index</a>
    </li>
    </ul>
  </div>
  <div id="searchInputDiv">
    Search: <input type="text" id="searchInput"
      onkeyup="search()" />
  </div>
  <div>
    Group by:
    <select onchange="groupBy(this.value)">
      <option value="section">Section</option>
      <option value="type">Type</option>
    </select>
  </div>
  <ul class="simple simple-toc" id="toc-list">
<li><a class="reference" id="example_toc" href="#example">Example</a></li>
<li>
  <a class="reference reference-toplevel" href="#7" id="57">Types</a>
  <ul class="simple simple-toc-section">
      <li><a class="reference" href="#Topic"
    title="Topic = distinct int">Topic</a></li>
  <li><a class="reference" href="#Subscriber"
    title="Subscriber = distinct int">Subscriber</a></li>
  <li><a class="reference" href="#SuberMessage"
    title="SuberMessage[TData] = object
  topics*: IntSet            ## The `Topic`s that this message belongs to
  timestamp*: MonoTime       ## Unique timestamp that orders and identifies messages
  data*: TData               ## Message payload, a generic type
  size: int                  ## Size of the data, used to trigger size-based deliveries">SuberMessage</a></li>
  <li><a class="reference" href="#DeliverCallback"
    title="DeliverCallback[TData] = proc (messages: openArray[ptr SuberMessage[TData]]) {.
    gcsafe, raises: [].}">DeliverCallback</a></li>
  <li><a class="reference" href="#PushCallback"
    title="PushCallback[TData] = proc (message: ptr SuberMessage[TData]) {.gcsafe,
    raises: [].}">PushCallback</a></li>
  <li><a class="reference" href="#PullCallback"
    title="PullCallback[TData] = proc (subscriber: Subscriber;
                            expiredtopics: openArray[Topic];
                            messages: openArray[ptr SuberMessage[TData]]) {.
    gcsafe, raises: [].}">PullCallback</a></li>
  <li><a class="reference" href="#Suber"
    title="Suber[TData; SuberMaxTopics] = ref object">Suber</a></li>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#12" id="62">Procs</a>
  <ul class="simple simple-toc-section">
      <ul class="simple nested-toc-section">subscribe
      <li><a class="reference" href="#subscribe%2CSuber%2CSubscriber%2C"
    title="subscribe(suber: Suber; subscriber: Subscriber; topic: Topic | int;
          createnewtopic = false): bool">subscribe,<wbr>Suber,<wbr>Subscriber,<wbr></a></li>

  </ul>
  <ul class="simple nested-toc-section">pull
      <li><a class="reference" href="#pull%2CSuber%5BTData%2CSuberMaxTopics%5D%2C%2CsinkIntSet%2CsinkMonoTime"
    title="pull[TData; SuberMaxTopics](suber: Suber[TData, SuberMaxTopics];
                            subscriber: Subscriber | int; topics: sink IntSet;
                            aftertimestamp: sink MonoTime)">pull,<wbr>Suber[TData,<wbr>SuberMaxTopics],<wbr>,<wbr>sinkIntSet,<wbr>sinkMonoTime</a></li>
  <li><a class="reference" href="#pull%2CSuber%5BTData%2CSuberMaxTopics%5D%2C%2C%2CsinkMonoTime"
    title="pull[TData; SuberMaxTopics](suber: Suber[TData, SuberMaxTopics];
                            subscriber: Subscriber | int; topic: Topic | int;
                            aftertimestamp: sink MonoTime)">pull,<wbr>Suber[TData,<wbr>SuberMaxTopics],<wbr>,<wbr>,<wbr>sinkMonoTime</a></li>

  </ul>
  <ul class="simple nested-toc-section">$
      <li><a class="reference" href="#%24%2CTopic"
    title="`$`(x: Topic): string">$,<wbr>Topic</a></li>
  <li><a class="reference" href="#%24%2CSubscriber"
    title="`$`(x: Subscriber): string">$,<wbr>Subscriber</a></li>

  </ul>
  <ul class="simple nested-toc-section">doDelivery
      <li><a class="reference" href="#doDelivery%2CSuber%5BTData%2CSuberMaxTopics%5D"
    title="doDelivery[TData; SuberMaxTopics](suber: Suber[TData, SuberMaxTopics])">doDelivery,<wbr>Suber[TData,<wbr>SuberMaxTopics]</a></li>

  </ul>
  <ul class="simple nested-toc-section">stopImmediately
      <li><a class="reference" href="#stopImmediately%2CSuber%5BTData%2CSuberMaxTopics%5D"
    title="stopImmediately[TData; SuberMaxTopics](suber: Suber[TData, SuberMaxTopics])">stopImmediately,<wbr>Suber[TData,<wbr>SuberMaxTopics]</a></li>

  </ul>
  <ul class="simple nested-toc-section">getSubscribersbytopic
      <li><a class="reference" href="#getSubscribersbytopic%2CSuber"
    title="getSubscribersbytopic(suber: Suber): seq[tuple[id: Topic, subscribers: IntSet]]">getSubscribersbytopic,<wbr>Suber</a></li>

  </ul>
  <ul class="simple nested-toc-section">push
      <li><a class="reference" href="#push%2CSuber%2CsinkIntSet%2CsinkTData%2Cint"
    title="push[TData](suber: Suber; topics: sink IntSet; data: sink TData; size: int = 0)">push,<wbr>Suber,<wbr>sinkIntSet,<wbr>sinkTData,<wbr>int</a></li>
  <li><a class="reference" href="#push%2CSuber%2C%2CsinkTData%2Cint"
    title="push[TData](suber: Suber; topic: Topic | int; data: sink TData; size: int = 0)">push,<wbr>Suber,<wbr>,<wbr>sinkTData,<wbr>int</a></li>

  </ul>
  <ul class="simple nested-toc-section">pullAll
      <li><a class="reference" href="#pullAll%2CSuber%5BTData%2CSuberMaxTopics%5D%2C%2C%2CsinkMonoTime"
    title="pullAll[TData; SuberMaxTopics](suber: Suber[TData, SuberMaxTopics];
                               subscriber: Subscriber | int; topic: Topic | int;
                               aftertimestamp: sink MonoTime)">pullAll,<wbr>Suber[TData,<wbr>SuberMaxTopics],<wbr>,<wbr>,<wbr>sinkMonoTime</a></li>

  </ul>
  <ul class="simple nested-toc-section">toMonoTime
      <li><a class="reference" href="#toMonoTime%2Cint64"
    title="toMonoTime(i: int64): MonoTime">toMonoTime,<wbr>int64</a></li>

  </ul>
  <ul class="simple nested-toc-section">hasTopic
      <li><a class="reference" href="#hasTopic%2CSuber%2C"
    title="hasTopic(suber: Suber; topic: Topic | int): bool">hasTopic,<wbr>Suber,<wbr></a></li>

  </ul>
  <ul class="simple nested-toc-section">getChannelQueueLengths
      <li><a class="reference" href="#getChannelQueueLengths%2CSuber"
    title="getChannelQueueLengths(suber: Suber): (int, int, int)">getChannelQueueLengths,<wbr>Suber</a></li>

  </ul>
  <ul class="simple nested-toc-section">stop
      <li><a class="reference" href="#stop%2CSuber%5BTData%2CSuberMaxTopics%5D"
    title="stop[TData; SuberMaxTopics](suber: Suber[TData, SuberMaxTopics])">stop,<wbr>Suber[TData,<wbr>SuberMaxTopics]</a></li>

  </ul>
  <ul class="simple nested-toc-section">getSubscribers
      <li><a class="reference" href="#getSubscribers%2CSuber%2C"
    title="getSubscribers(suber: Suber; topic: Topic | int): IntSet">getSubscribers,<wbr>Suber,<wbr></a></li>
  <li><a class="reference" href="#getSubscribers%2CSuber"
    title="getSubscribers(suber: Suber): IntSet">getSubscribers,<wbr>Suber</a></li>
  <li><a class="reference" href="#getSubscribers%2CSuber%2CopenArray%5BTopic%5D"
    title="getSubscribers(suber: Suber; topics: openArray[Topic]): IntSet">getSubscribers,<wbr>Suber,<wbr>openArray[Topic]</a></li>
  <li><a class="reference" href="#getSubscribers%2CSuber%2Cptr.SuberMessage%2CIntSet"
    title="getSubscribers(suber: Suber; message: ptr SuberMessage; toset: var IntSet;
               clear = true)">getSubscribers,<wbr>Suber,<wbr>ptr.SuberMessage,<wbr>IntSet</a></li>

  </ul>
  <ul class="simple nested-toc-section">addTopic
      <li><a class="reference" href="#addTopic%2CSuber%2C"
    title="addTopic(suber: Suber; topic: Topic | int): bool">addTopic,<wbr>Suber,<wbr></a></li>

  </ul>
  <ul class="simple nested-toc-section">getTopiccount
      <li><a class="reference" href="#getTopiccount%2CSuber"
    title="getTopiccount(suber: Suber): int">getTopiccount,<wbr>Suber</a></li>

  </ul>
  <ul class="simple nested-toc-section">newSuber
      <li><a class="reference" href="#newSuber%2Cint%2Cint%2Cint"
    title="newSuber[TData; SuberMaxTopics: static int](cachemaxcapacity = 10000000;
    cachelength = 1000000; maxdelivery = -1; channelsize = 200): Suber[TData,
    SuberMaxTopics]">newSuber,<wbr>int,<wbr>int,<wbr>int</a></li>

  </ul>
  <ul class="simple nested-toc-section">toIntSet
      <li><a class="reference" href="#toIntSet%2CopenArray%5BTopic%5D"
    title="toIntSet(x: openArray[Topic]): IntSet">toIntSet,<wbr>openArray[Topic]</a></li>
  <li><a class="reference" href="#toIntSet%2CopenArray%5BSubscriber%5D"
    title="toIntSet(x: openArray[Subscriber]): IntSet">toIntSet,<wbr>openArray[Subscriber]</a></li>

  </ul>
  <ul class="simple nested-toc-section">isSubscriber
      <li><a class="reference" href="#isSubscriber%2CSuber%2CSubscriber%2CTopic"
    title="isSubscriber(suber: Suber; subscriber: Subscriber; topic: Topic): bool">isSubscriber,<wbr>Suber,<wbr>Subscriber,<wbr>Topic</a></li>

  </ul>
  <ul class="simple nested-toc-section">doSynced
      <li><a class="reference" href="#doSynced%2CSuber%5BTData%2CSuberMaxTopics%5D%2Cproc%29"
    title="doSynced[TData; SuberMaxTopics](suber: Suber[TData, SuberMaxTopics];
                                callback: proc () {.gcsafe, raises: [].})">doSynced,<wbr>Suber[TData,<wbr>SuberMaxTopics],<wbr>proc)</a></li>

  </ul>
  <ul class="simple nested-toc-section">unsubscribe
      <li><a class="reference" href="#unsubscribe%2CSuber%2CSubscriber%2CTopic"
    title="unsubscribe(suber: Suber; subscriber: Subscriber; topic: Topic)">unsubscribe,<wbr>Suber,<wbr>Subscriber,<wbr>Topic</a></li>

  </ul>
  <ul class="simple nested-toc-section">setPullCallback
      <li><a class="reference" href="#setPullCallback%2CSuber%2CPullCallback%5BTData%5D"
    title="setPullCallback[TData](suber: Suber; onPull: PullCallback[TData])">setPullCallback,<wbr>Suber,<wbr>PullCallback[TData]</a></li>

  </ul>
  <ul class="simple nested-toc-section">removeTopic
      <li><a class="reference" href="#removeTopic%2CSuber%2C"
    title="removeTopic(suber: Suber; topic: Topic | int)">removeTopic,<wbr>Suber,<wbr></a></li>

  </ul>
  <ul class="simple nested-toc-section">find
      <li><a class="reference" href="#find%2CSuber%2CMonoTime%2Cproc%28MonoTime%2Cptr.SuberMessage%5BTData%5D%29"
    title="find[TData](suber: Suber; query: MonoTime; callback: proc (query: MonoTime;
    message: ptr SuberMessage[TData]) {.gcsafe, raises: [].})">find,<wbr>Suber,<wbr>MonoTime,<wbr>proc(MonoTime,<wbr>ptr.SuberMessage[TData])</a></li>

  </ul>
  <ul class="simple nested-toc-section">setPushCallback
      <li><a class="reference" href="#setPushCallback%2CSuber%2CPushCallback%5BTData%5D"
    title="setPushCallback[TData](suber: Suber; onPush: PushCallback[TData])">setPushCallback,<wbr>Suber,<wbr>PushCallback[TData]</a></li>

  </ul>
  <ul class="simple nested-toc-section">removeSubscriber
      <li><a class="reference" href="#removeSubscriber%2CSuber%2CSubscriber"
    title="removeSubscriber(suber: Suber; subscriber: Subscriber)">removeSubscriber,<wbr>Suber,<wbr>Subscriber</a></li>

  </ul>
  <ul class="simple nested-toc-section">getSubscriptions
      <li><a class="reference" href="#getSubscriptions%2CSuber%2CSubscriber"
    title="getSubscriptions(suber: Suber; subscriber: Subscriber): seq[Topic]">getSubscriptions,<wbr>Suber,<wbr>Subscriber</a></li>

  </ul>
  <ul class="simple nested-toc-section">==
      <li><a class="reference" href="#%3D%3D%2CTopic%2CTopic"
    title="`==`(x, y: Topic): bool">==,<wbr>Topic,<wbr>Topic</a></li>
  <li><a class="reference" href="#%3D%3D%2CSubscriber%2CSubscriber"
    title="`==`(x, y: Subscriber): bool">==,<wbr>Subscriber,<wbr>Subscriber</a></li>

  </ul>
  <ul class="simple nested-toc-section">setDeliverCallback
      <li><a class="reference" href="#setDeliverCallback%2CSuber%2CDeliverCallback%5BTData%5D"
    title="setDeliverCallback[TData](suber: Suber; onDeliver: DeliverCallback[TData])">setDeliverCallback,<wbr>Suber,<wbr>DeliverCallback[TData]</a></li>

  </ul>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#16" id="66">Converters</a>
  <ul class="simple simple-toc-section">
      <li><a class="reference" href="#toTopic.c%2Cint"
    title="toTopic(x: int): Topic">toTopic</a></li>

  </ul>
</li>

</ul>

  </div>
  <div class="nine columns" id="content">
  <div id="tocRoot"></div>
  
  <p class="module-desc"><p>A Pub/Sub engine.</p>
<p>Receives messages from multiple sources and delivers them as a serialized stream. Publisher threads do not block each other or delivery thread, and delivery does not block publishing. Messages can belong to multiple topics. Subscribers can subscribe to multiple topics. Topics, subscribers and subscriptions can be modified anytime. Delivery may be triggered on message push, size of undelivered messages, amount of undelivered messages and on call. Keeps a message cache so that subscribers can sync their state at will.</p>

<h1><a class="toc-backref" id="example" href="#example">Example</a></h1><pre class="listing"><span class="Comment"># nim c -r --gc:arc --threads:on --d:release example.nim</span>
<span class="Keyword">import</span> <span class="Identifier">suber</span><span class="Punctuation">,</span> <span class="Identifier">os</span><span class="Punctuation">,</span> <span class="Identifier">random</span><span class="Punctuation">,</span> <span class="Identifier">times</span>

<span class="Keyword">let</span> <span class="Identifier">topics</span> <span class="Operator">=</span> <span class="Punctuation">[</span><span class="StringLit">&quot;Art&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Science&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Nim&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Fishing&quot;</span><span class="Punctuation">]</span>
<span class="Keyword">let</span> <span class="Identifier">subscribers</span> <span class="Operator">=</span> <span class="Punctuation">[</span><span class="StringLit">&quot;Amy&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Bob&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Chas&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Dave&quot;</span><span class="Punctuation">]</span>
<span class="Keyword">let</span> <span class="Identifier">messagedatas</span> <span class="Operator">=</span> <span class="Punctuation">[</span><span class="StringLit">&quot;Good News&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Bad News&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Breaking News&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Old News&quot;</span><span class="Punctuation">]</span>
<span class="Keyword">let</span> <span class="Identifier">publishers</span> <span class="Operator">=</span> <span class="Punctuation">[</span><span class="StringLit">&quot;Helsinki&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Tallinn&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Oslo&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Edinburgh&quot;</span><span class="Punctuation">]</span>
<span class="Keyword">let</span> <span class="Identifier">bus</span> <span class="Operator">=</span> <span class="Identifier">newSuber</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">,</span> <span class="DecNumber">4</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Comment"># string datas, max 4 topics</span>
<span class="Keyword">var</span> <span class="Identifier">stop</span><span class="Punctuation">:</span> <span class="Identifier">bool</span>

<span class="Keyword">proc</span> <span class="Identifier">generateMessages</span><span class="Punctuation">(</span><span class="Identifier">publisher</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">gcsafe</span><span class="Operator">.</span><span class="Punctuation">}</span><span class="Punctuation">:</span>
    <span class="Keyword">while</span> <span class="Identifier">true</span><span class="Punctuation">:</span>
      <span class="Keyword">if</span> <span class="Identifier">stop</span><span class="Punctuation">:</span> <span class="Keyword">break</span> <span class="Keyword">else</span><span class="Punctuation">:</span> <span class="Punctuation">(</span><span class="Identifier">sleep</span><span class="Punctuation">(</span><span class="DecNumber">100</span><span class="Operator">+</span><span class="Identifier">rand</span><span class="Punctuation">(</span><span class="DecNumber">500</span><span class="Punctuation">)</span><span class="Punctuation">)</span> <span class="Punctuation">;</span> <span class="Keyword">if</span> <span class="Identifier">stop</span><span class="Punctuation">:</span> <span class="Keyword">break</span><span class="Punctuation">)</span>
      <span class="Identifier">write</span><span class="Punctuation">(</span><span class="Identifier">stdout</span><span class="Punctuation">,</span> <span class="Operator">$</span><span class="Identifier">publishers</span><span class="Punctuation">[</span><span class="Identifier">publisher</span><span class="Punctuation">]</span> <span class="Operator">&amp;</span> <span class="StringLit">&quot;, &quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">flushFile</span><span class="Punctuation">(</span><span class="Identifier">stdout</span><span class="Punctuation">)</span>
      <span class="Keyword">var</span> <span class="Identifier">messagetopics</span> <span class="Operator">=</span> <span class="Identifier">initIntSet</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
      <span class="Keyword">for</span> <span class="Identifier">topicnumber</span> <span class="Keyword">in</span> <span class="DecNumber">1</span> <span class="Operator">..</span> <span class="DecNumber">1</span> <span class="Operator">+</span> <span class="Identifier">rand</span><span class="Punctuation">(</span><span class="DecNumber">2</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">messagetopics</span><span class="Operator">.</span><span class="Identifier">incl</span><span class="Punctuation">(</span><span class="Identifier">rand</span><span class="Punctuation">(</span><span class="DecNumber">3</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
      <span class="Identifier">bus</span><span class="Operator">.</span><span class="Identifier">push</span><span class="Punctuation">(</span><span class="Identifier">messagetopics</span><span class="Punctuation">,</span> <span class="Identifier">messagedatas</span><span class="Punctuation">[</span><span class="Identifier">rand</span><span class="Punctuation">(</span><span class="DecNumber">3</span><span class="Punctuation">)</span><span class="Punctuation">]</span> <span class="Operator">&amp;</span> <span class="StringLit">&quot; from &quot;</span> <span class="Operator">&amp;</span> <span class="Identifier">publishers</span><span class="Punctuation">[</span><span class="Identifier">publisher</span><span class="Punctuation">]</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">deliver</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">gcsafe</span><span class="Operator">.</span><span class="Punctuation">}</span><span class="Punctuation">:</span>
    <span class="Keyword">for</span> <span class="Identifier">i</span> <span class="Keyword">in</span> <span class="DecNumber">1</span> <span class="Operator">..</span> <span class="DecNumber">10</span><span class="Punctuation">:</span> <span class="Punctuation">(</span><span class="Identifier">sleep</span><span class="Punctuation">(</span><span class="DecNumber">1000</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Identifier">echo</span> <span class="StringLit">&quot;&quot;</span><span class="Punctuation">;</span> <span class="Identifier">bus</span><span class="Operator">.</span><span class="Identifier">doDelivery</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
    <span class="Identifier">stop</span> <span class="Operator">=</span> <span class="Identifier">true</span>

<span class="Keyword">proc</span> <span class="Identifier">writeMessages</span><span class="Punctuation">(</span><span class="Identifier">subscriber</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">,</span> <span class="Identifier">messages</span><span class="Punctuation">:</span> <span class="Identifier">openArray</span><span class="Punctuation">[</span><span class="Keyword">ptr</span> <span class="Identifier">SuberMessage</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">subscriberids</span><span class="Punctuation">:</span> <span class="Identifier">IntSet</span>
  <span class="Keyword">try</span><span class="Punctuation">:</span>
    <span class="Keyword">for</span> <span class="Identifier">message</span> <span class="Keyword">in</span> <span class="Identifier">messages</span><span class="Punctuation">:</span>
      <span class="Keyword">if</span> <span class="Identifier">subscriber</span> <span class="Operator">&gt;</span> <span class="Operator">-</span><span class="DecNumber">1</span><span class="Punctuation">:</span>
        <span class="Identifier">stdout</span><span class="Operator">.</span><span class="Identifier">write</span><span class="Punctuation">(</span><span class="StringLit">&quot;@&quot;</span> <span class="Operator">&amp;</span> <span class="Operator">$</span><span class="Identifier">message</span><span class="Operator">.</span><span class="Identifier">timestamp</span> <span class="Operator">&amp;</span> <span class="StringLit">&quot; to &quot;</span> <span class="Operator">&amp;</span> <span class="Identifier">subscribers</span><span class="Punctuation">[</span><span class="Identifier">subscriber</span><span class="Punctuation">]</span> <span class="Operator">&amp;</span> <span class="StringLit">&quot;, &quot;</span><span class="Punctuation">)</span>
      <span class="Keyword">else</span><span class="Punctuation">:</span>
        <span class="Identifier">stdout</span><span class="Operator">.</span><span class="Identifier">write</span><span class="Punctuation">(</span><span class="StringLit">&quot;@&quot;</span> <span class="Operator">&amp;</span> <span class="Operator">$</span><span class="Identifier">message</span><span class="Operator">.</span><span class="Identifier">timestamp</span> <span class="Operator">&amp;</span> <span class="StringLit">&quot; to &quot;</span><span class="Punctuation">)</span>
        <span class="Identifier">bus</span><span class="Operator">.</span><span class="Identifier">getSubscribers</span><span class="Punctuation">(</span><span class="Identifier">message</span><span class="Punctuation">,</span> <span class="Identifier">subscriberids</span><span class="Punctuation">)</span>
        <span class="Keyword">for</span> <span class="Identifier">subscriberid</span> <span class="Keyword">in</span> <span class="Identifier">subscriberids</span><span class="Punctuation">:</span> <span class="Identifier">stdout</span><span class="Operator">.</span><span class="Identifier">write</span><span class="Punctuation">(</span><span class="Identifier">subscribers</span><span class="Punctuation">[</span><span class="Identifier">subscriberid</span><span class="Punctuation">]</span> <span class="Operator">&amp;</span> <span class="StringLit">&quot;, &quot;</span><span class="Punctuation">)</span>
      <span class="Identifier">stdout</span><span class="Operator">.</span><span class="Identifier">write</span><span class="Punctuation">(</span><span class="StringLit">&quot;concerning &quot;</span><span class="Punctuation">)</span>
      <span class="Keyword">for</span> <span class="Identifier">topic</span> <span class="Keyword">in</span> <span class="Identifier">message</span><span class="Operator">.</span><span class="Identifier">topics</span><span class="Operator">.</span><span class="Identifier">items</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">stdout</span><span class="Operator">.</span><span class="Identifier">write</span><span class="Punctuation">(</span><span class="Identifier">topics</span><span class="Punctuation">[</span><span class="Identifier">topic</span><span class="Operator">.</span><span class="Identifier">int</span><span class="Punctuation">]</span> <span class="Operator">&amp;</span> <span class="StringLit">&quot; &amp; &quot;</span><span class="Punctuation">)</span>
      <span class="Identifier">stdout</span><span class="Operator">.</span><span class="Identifier">writeLine</span><span class="Punctuation">(</span><span class="StringLit">&quot;</span><span class="EscapeSequence">\b</span><span class="EscapeSequence">\b</span><span class="StringLit">: &quot;</span> <span class="Operator">&amp;</span> <span class="Identifier">message</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">)</span>
    <span class="Identifier">stdout</span><span class="Operator">.</span><span class="Identifier">flushFile</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
    <span class="Keyword">if</span> <span class="Identifier">subscriber</span> <span class="Operator">&gt;</span> <span class="Operator">-</span><span class="DecNumber">1</span><span class="Punctuation">:</span> <span class="Identifier">echo</span> <span class="StringLit">&quot;--&quot;</span>
  <span class="Keyword">except</span><span class="Punctuation">:</span> <span class="Keyword">discard</span> <span class="Comment"># write IOError</span>
 
 <span class="Keyword">proc</span> <span class="Identifier">onPull</span><span class="Punctuation">(</span><span class="Identifier">subscriber</span><span class="Punctuation">:</span> <span class="Identifier">Subscriber</span><span class="Punctuation">,</span> <span class="Identifier">expiredtopics</span><span class="Punctuation">:</span> <span class="Identifier">openArray</span><span class="Punctuation">[</span><span class="Identifier">Topic</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Identifier">messages</span><span class="Punctuation">:</span> <span class="Identifier">openArray</span><span class="Punctuation">[</span><span class="Keyword">ptr</span> <span class="Identifier">SuberMessage</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">gcsafe</span><span class="Operator">.</span><span class="Punctuation">}</span><span class="Punctuation">:</span>
    <span class="Keyword">if</span> <span class="Identifier">expiredtopics</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">&gt;</span> <span class="DecNumber">0</span><span class="Punctuation">:</span> <span class="Identifier">echo</span> <span class="StringLit">&quot;Sorry, not stocking that old news anymore.&quot;</span>
    <span class="Keyword">else</span><span class="Punctuation">:</span> <span class="Identifier">writeMessages</span><span class="Punctuation">(</span><span class="Identifier">int</span><span class="Punctuation">(</span><span class="Identifier">subscriber</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Identifier">messages</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">redeliver</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">gcsafe</span><span class="Operator">.</span><span class="Punctuation">}</span><span class="Punctuation">:</span>
    <span class="Keyword">while</span> <span class="Identifier">true</span><span class="Punctuation">:</span>
      <span class="Keyword">if</span> <span class="Identifier">stop</span><span class="Punctuation">:</span> <span class="Keyword">break</span> <span class="Keyword">else</span><span class="Punctuation">:</span> <span class="Punctuation">(</span><span class="Identifier">sleep</span><span class="Punctuation">(</span><span class="DecNumber">2000</span><span class="Operator">+</span><span class="Identifier">rand</span><span class="Punctuation">(</span><span class="DecNumber">3000</span><span class="Punctuation">)</span><span class="Punctuation">)</span> <span class="Punctuation">;</span> <span class="Keyword">if</span> <span class="Identifier">stop</span><span class="Punctuation">:</span> <span class="Keyword">break</span><span class="Punctuation">)</span>
      <span class="Keyword">let</span> <span class="Identifier">since</span> <span class="Operator">=</span> <span class="Identifier">getMonoTime</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">-</span> <span class="Identifier">initDuration</span><span class="Punctuation">(</span><span class="Identifier">milliseconds</span> <span class="Operator">=</span> <span class="DecNumber">500</span> <span class="Operator">+</span> <span class="Identifier">rand</span><span class="Punctuation">(</span><span class="DecNumber">1500</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
      <span class="Identifier">echo</span> <span class="StringLit">&quot;&quot;</span> <span class="Punctuation">;</span> <span class="Identifier">echo</span> <span class="StringLit">&quot;--&quot;</span> <span class="Punctuation">;</span> <span class="Identifier">echo</span><span class="Punctuation">(</span><span class="StringLit">&quot;Chas requests Nim-related news since timestamp @&quot;</span><span class="Punctuation">,</span> <span class="Identifier">since</span><span class="Punctuation">)</span>
      <span class="Keyword">let</span> <span class="Identifier">subscriber</span> <span class="Operator">=</span> <span class="Identifier">subscribers</span><span class="Operator">.</span><span class="Identifier">find</span><span class="Punctuation">(</span><span class="StringLit">&quot;Chas&quot;</span><span class="Punctuation">)</span>
      <span class="Identifier">bus</span><span class="Operator">.</span><span class="Identifier">pull</span><span class="Punctuation">(</span><span class="Identifier">subscriber</span><span class="Punctuation">,</span> <span class="Identifier">toIntSet</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="Identifier">topics</span><span class="Operator">.</span><span class="Identifier">find</span><span class="Punctuation">(</span><span class="StringLit">&quot;Nim&quot;</span><span class="Punctuation">)</span><span class="Punctuation">]</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Identifier">since</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">onDeliver</span><span class="Punctuation">(</span><span class="Identifier">messages</span><span class="Punctuation">:</span> <span class="Identifier">openArray</span><span class="Punctuation">[</span><span class="Keyword">ptr</span> <span class="Identifier">SuberMessage</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">gcsafe</span><span class="Punctuation">,</span> <span class="Identifier">raises</span><span class="Punctuation">:</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Operator">.</span><span class="Punctuation">}</span> <span class="Operator">=</span>
  <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">gcsafe</span><span class="Operator">.</span><span class="Punctuation">}</span><span class="Punctuation">:</span> <span class="Identifier">writeMessages</span><span class="Punctuation">(</span><span class="Operator">-</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="Identifier">messages</span><span class="Punctuation">)</span>

<span class="Identifier">bus</span><span class="Operator">.</span><span class="Identifier">setDeliverCallback</span><span class="Punctuation">(</span><span class="Identifier">onDeliver</span><span class="Punctuation">)</span>
<span class="Identifier">bus</span><span class="Operator">.</span><span class="Identifier">setPullCallback</span><span class="Punctuation">(</span><span class="Identifier">onPull</span><span class="Punctuation">)</span>
<span class="Keyword">for</span> <span class="Identifier">i</span> <span class="Keyword">in</span> <span class="DecNumber">0</span> <span class="Operator">..&lt;</span> <span class="DecNumber">4</span><span class="Punctuation">:</span> <span class="Punctuation">(</span><span class="Keyword">for</span> <span class="Identifier">j</span> <span class="Keyword">in</span> <span class="DecNumber">0</span> <span class="Operator">..</span> <span class="Identifier">i</span><span class="Punctuation">:</span> <span class="Identifier">bus</span><span class="Operator">.</span><span class="Identifier">subscribe</span><span class="Punctuation">(</span><span class="Identifier">i</span><span class="Operator">.</span><span class="Identifier">Subscriber</span><span class="Punctuation">,</span> <span class="Identifier">j</span><span class="Operator">.</span><span class="Identifier">Topic</span><span class="Punctuation">,</span> <span class="Identifier">true</span><span class="Punctuation">)</span><span class="Punctuation">)</span>

<span class="Keyword">var</span> <span class="Identifier">delivererthread</span><span class="Punctuation">:</span> <span class="Identifier">Thread</span><span class="Punctuation">[</span><span class="Identifier">void</span><span class="Punctuation">]</span>
<span class="Identifier">createThread</span><span class="Punctuation">(</span><span class="Identifier">delivererthread</span><span class="Punctuation">,</span> <span class="Identifier">deliver</span><span class="Punctuation">)</span>
<span class="Keyword">var</span> <span class="Identifier">redelivererthread</span><span class="Punctuation">:</span> <span class="Identifier">Thread</span><span class="Punctuation">[</span><span class="Identifier">void</span><span class="Punctuation">]</span>
<span class="Identifier">createThread</span><span class="Punctuation">(</span><span class="Identifier">redelivererthread</span><span class="Punctuation">,</span> <span class="Identifier">redeliver</span><span class="Punctuation">)</span>
<span class="Keyword">var</span> <span class="Identifier">publisherthreads</span><span class="Punctuation">:</span> <span class="Identifier">array</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">Thread</span><span class="Punctuation">[</span><span class="Identifier">int</span><span class="Punctuation">]</span><span class="Punctuation">]</span>
<span class="Keyword">for</span> <span class="Identifier">i</span> <span class="Keyword">in</span> <span class="DecNumber">0</span> <span class="Operator">..&lt;</span> <span class="DecNumber">4</span><span class="Punctuation">:</span> <span class="Identifier">createThread</span><span class="Punctuation">(</span><span class="Identifier">publisherthreads</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Identifier">generateMessages</span><span class="Punctuation">,</span> <span class="Identifier">i</span><span class="Punctuation">)</span>
<span class="Identifier">joinThreads</span> <span class="Identifier">publisherthreads</span> <span class="Punctuation">;</span> <span class="Identifier">bus</span><span class="Operator">.</span><span class="Identifier">stop</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Identifier">joinThreads</span><span class="Punctuation">(</span><span class="Punctuation">[</span><span class="Identifier">delivererthread</span><span class="Punctuation">,</span> <span class="Identifier">redelivererthread</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Punctuation">;</span> <span class="Identifier">echo</span> <span class="StringLit">&quot;&quot;</span></pre></p>
  <div class="section" id="7">
<h1><a class="toc-backref" href="#7">Types</a></h1>
<dl class="item">
<a id="Topic"></a>
<dt><pre><a href="index.html#Topic"><span class="Identifier">Topic</span></a> <span class="Other">=</span> <span class="Keyword">distinct</span> <span class="Identifier">int</span></pre></dt>
<dd>



</dd>
<a id="Subscriber"></a>
<dt><pre><a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a> <span class="Other">=</span> <span class="Keyword">distinct</span> <span class="Identifier">int</span></pre></dt>
<dd>



</dd>
<a id="SuberMessage"></a>
<dt><pre><a href="index.html#SuberMessage"><span class="Identifier">SuberMessage</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span> <span class="Other">=</span> <span class="Keyword">object</span>
  <span class="Identifier">topics</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">IntSet</span>            <span class="Comment">## The `Topic`s that this message belongs to</span>
  <span class="Identifier">timestamp</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">MonoTime</span>       <span class="Comment">## Unique timestamp that orders and identifies messages</span>
  <span class="Identifier">data</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">TData</span>               <span class="Comment">## Message payload, a generic type</span>
  <span class="Identifier">size</span><span class="Other">:</span> <span class="Identifier">int</span>                  <span class="Comment">## Size of the data, used to trigger size-based deliveries</span>
  </pre></dt>
<dd>

push, pull, deliver and find -callbacks will return (pointers to) SuberMessages.

</dd>
<a id="DeliverCallback"></a>
<dt><pre><a href="index.html#DeliverCallback"><span class="Identifier">DeliverCallback</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span> <span class="Other">=</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Identifier">messages</span><span class="Other">:</span> <span class="Identifier">openArray</span><span class="Other">[</span><span class="Keyword">ptr</span> <a href="index.html#SuberMessage"><span class="Identifier">SuberMessage</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">]</span><span class="Other">)</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma">
    <span class="Identifier">gcsafe</span><span class="Other">,</span> <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

<p>Proc that gets called when there are messages to be delivered. Set this with <tt class="docutils literal"><span class="pre">setDeliverCallback</span></tt>.</p>
<p>Note that DeliverCallback must be gcsafe and not raise any exceptions.</p>


</dd>
<a id="PushCallback"></a>
<dt><pre><a href="index.html#PushCallback"><span class="Identifier">PushCallback</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span> <span class="Other">=</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Identifier">message</span><span class="Other">:</span> <span class="Keyword">ptr</span> <a href="index.html#SuberMessage"><span class="Identifier">SuberMessage</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">)</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">gcsafe</span><span class="Other">,</span>
    <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

<p>Proc that gets called <strong>every</strong> time when a new message is published. Set this with <tt class="docutils literal"><span class="pre">setPushCallback</span></tt>.</p>
<p>Note that PushCallback must be gcsafe and not raise any exceptions.</p>


</dd>
<a id="PullCallback"></a>
<dt><pre><a href="index.html#PullCallback"><span class="Identifier">PullCallback</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span> <span class="Other">=</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Identifier">subscriber</span><span class="Other">:</span> <a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a><span class="Other">;</span>
                            <span class="Identifier">expiredtopics</span><span class="Other">:</span> <span class="Identifier">openArray</span><span class="Other">[</span><a href="index.html#Topic"><span class="Identifier">Topic</span></a><span class="Other">]</span><span class="Other">;</span>
                            <span class="Identifier">messages</span><span class="Other">:</span> <span class="Identifier">openArray</span><span class="Other">[</span><span class="Keyword">ptr</span> <a href="index.html#SuberMessage"><span class="Identifier">SuberMessage</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">]</span><span class="Other">)</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma">
    <span class="Identifier">gcsafe</span><span class="Other">,</span> <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

<p>Proc that is called when subscriber pulls old messages.<p><tt class="docutils literal"><span class="pre">subscriber</span></tt> identifies the puller<br /><tt class="docutils literal"><span class="pre">expiredtopics</span></tt> is list of topics for which all messages are not anymore cached<br /><tt class="docutils literal"><span class="pre">messages</span></tt> includes results for topics that had all requested messages still in cache<br /></p> Set this with <tt class="docutils literal"><span class="pre">setPullCallback</span></tt>.</p>
<p>Note that PullCallback must be gcsafe and not raise any exceptions.</p>


</dd>
<a id="Suber"></a>
<dt><pre><a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">;</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span> <span class="Other">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span>
  </pre></dt>
<dd>

The Suber service. Create one with <tt class="docutils literal"><span class="pre">newSuber</span></tt>.<p>TData is the generic parameter that defines the type of message data<br />SuberMaxTopics is maximum amount of distinct topics<br /></p><p>Note: If you have distinct topics (subscriber partitions) and application logic allows, it may be profitable to have dedicated Suber for each partition.</p>


</dd>

</dl></div>
<div class="section" id="12">
<h1><a class="toc-backref" href="#12">Procs</a></h1>
<dl class="item">
<a id="==,Topic,Topic"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%3D%3D%2CTopic%2CTopic"><span class="Identifier">`==`</span></a><span class="Other">(</span><span class="Identifier">x</span><span class="Other">,</span> <span class="Identifier">y</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">borrow</span></span><span class="Other">.}</span></span></pre></dt>
<dd>



</dd>
<a id="==,Subscriber,Subscriber"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%3D%3D%2CSubscriber%2CSubscriber"><span class="Identifier">`==`</span></a><span class="Other">(</span><span class="Identifier">x</span><span class="Other">,</span> <span class="Identifier">y</span><span class="Other">:</span> <a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">borrow</span></span><span class="Other">.}</span></span></pre></dt>
<dd>



</dd>
<a id="$,Topic"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%24%2CTopic"><span class="Identifier">`$`</span></a><span class="Other">(</span><span class="Identifier">x</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">string</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">borrow</span></span><span class="Other">.}</span></span></pre></dt>
<dd>



</dd>
<a id="$,Subscriber"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%24%2CSubscriber"><span class="Identifier">`$`</span></a><span class="Other">(</span><span class="Identifier">x</span><span class="Other">:</span> <a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">string</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">borrow</span></span><span class="Other">.}</span></span></pre></dt>
<dd>



</dd>
<a id="toMonoTime,int64"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#toMonoTime%2Cint64"><span class="Identifier">toMonoTime</span></a><span class="Other">(</span><span class="Identifier">i</span><span class="Other">:</span> <span class="Identifier">int64</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">MonoTime</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">inline</span><span class="Other">,</span> <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>



</dd>
<a id="toIntSet,openArray[Topic]"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#toIntSet%2CopenArray%5BTopic%5D"><span class="Identifier">toIntSet</span></a><span class="Other">(</span><span class="Identifier">x</span><span class="Other">:</span> <span class="Identifier">openArray</span><span class="Other">[</span><a href="index.html#Topic"><span class="Identifier">Topic</span></a><span class="Other">]</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">IntSet</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">inline</span><span class="Other">,</span> <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>



</dd>
<a id="toIntSet,openArray[Subscriber]"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#toIntSet%2CopenArray%5BSubscriber%5D"><span class="Identifier">toIntSet</span></a><span class="Other">(</span><span class="Identifier">x</span><span class="Other">:</span> <span class="Identifier">openArray</span><span class="Other">[</span><a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a><span class="Other">]</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">IntSet</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">inline</span><span class="Other">,</span> <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>



</dd>
<a id="newSuber,int,int,int"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#newSuber%2Cint%2Cint%2Cint"><span class="Identifier">newSuber</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">;</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">:</span> <span class="Identifier">static</span> <span class="Identifier">int</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">cachemaxcapacity</span> <span class="Other">=</span> <span class="DecNumber">10000000</span><span class="Other">;</span>
    <span class="Identifier">cachelength</span> <span class="Other">=</span> <span class="DecNumber">1000000</span><span class="Other">;</span> <span class="Identifier">maxdelivery</span> <span class="Other">=</span> <span class="Operator">-</span><span class="DecNumber">1</span><span class="Other">;</span> <span class="Identifier">channelsize</span> <span class="Other">=</span> <span class="DecNumber">200</span><span class="Other">)</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">,</span>
    <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span></pre></dt>
<dd>



</dd>
<a id="setPushCallback,Suber,PushCallback[TData]"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#setPushCallback%2CSuber%2CPushCallback%5BTData%5D"><span class="Identifier">setPushCallback</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">onPush</span><span class="Other">:</span> <a href="index.html#PushCallback"><span class="Identifier">PushCallback</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">)</span></pre></dt>
<dd>



</dd>
<a id="setDeliverCallback,Suber,DeliverCallback[TData]"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#setDeliverCallback%2CSuber%2CDeliverCallback%5BTData%5D"><span class="Identifier">setDeliverCallback</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">onDeliver</span><span class="Other">:</span> <a href="index.html#DeliverCallback"><span class="Identifier">DeliverCallback</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">)</span></pre></dt>
<dd>



</dd>
<a id="setPullCallback,Suber,PullCallback[TData]"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#setPullCallback%2CSuber%2CPullCallback%5BTData%5D"><span class="Identifier">setPullCallback</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">onPull</span><span class="Other">:</span> <a href="index.html#PullCallback"><span class="Identifier">PullCallback</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">)</span></pre></dt>
<dd>



</dd>
<a id="stop,Suber[TData,SuberMaxTopics]"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#stop%2CSuber%5BTData%2CSuberMaxTopics%5D"><span class="Identifier">stop</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">;</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">,</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">)</span></pre></dt>
<dd>

<p>1: refuses to accept new messages<br />2: returns the processing thread for joining<br />3: all already accepted messages (in the channel buffer) are processed to cache (may trigger deliveries)<br />4: executes one final delivery, if undelivered messages exist in cache<br />5: processing loop stops, thread is stopped and joined with caller<br /></p>

</dd>
<a id="stopImmediately,Suber[TData,SuberMaxTopics]"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#stopImmediately%2CSuber%5BTData%2CSuberMaxTopics%5D"><span class="Identifier">stopImmediately</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">;</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">,</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">)</span></pre></dt>
<dd>

instantly stops the service

</dd>
<a id="getChannelQueueLengths,Suber"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#getChannelQueueLengths%2CSuber"><span class="Identifier">getChannelQueueLengths</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Other">(</span><span class="Identifier">int</span><span class="Other">,</span> <span class="Identifier">int</span><span class="Other">,</span> <span class="Identifier">int</span><span class="Other">)</span></pre></dt>
<dd>

Reports amounts of buffered messages in channel queue for monitoring and backpressure purposes:<p>first field: Current number of messages in the channel buffer<br />second field: Peak number of queued messages since queue was empty<br />third field: Maximum number of queued messages ever<br /></p>

</dd>
<a id="addTopic,Suber,"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#addTopic%2CSuber%2C"><span class="Identifier">addTopic</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">topic</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a> <span class="Operator">|</span> <span class="Identifier">int</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">discardable</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

<p>Adds new topic.</p>
<p>Returns false if maximum number of topics is already added.</p>


</dd>
<a id="removeTopic,Suber,"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#removeTopic%2CSuber%2C"><span class="Identifier">removeTopic</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">topic</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a> <span class="Operator">|</span> <span class="Identifier">int</span><span class="Other">)</span></pre></dt>
<dd>



</dd>
<a id="hasTopic,Suber,"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#hasTopic%2CSuber%2C"><span class="Identifier">hasTopic</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">topic</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a> <span class="Operator">|</span> <span class="Identifier">int</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span></pre></dt>
<dd>



</dd>
<a id="getTopiccount,Suber"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#getTopiccount%2CSuber"><span class="Identifier">getTopiccount</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">int</span></pre></dt>
<dd>



</dd>
<a id="getSubscribersbytopic,Suber"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#getSubscribersbytopic%2CSuber"><span class="Identifier">getSubscribersbytopic</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">seq</span><span class="Other">[</span>
    <span class="Keyword">tuple</span><span class="Other">[</span><span class="Identifier">id</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a><span class="Other">,</span> <span class="Identifier">subscribers</span><span class="Other">:</span> <span class="Identifier">IntSet</span><span class="Other">]</span><span class="Other">]</span></pre></dt>
<dd>

Reports subscribers for each topic.

</dd>
<a id="subscribe,Suber,Subscriber,"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#subscribe%2CSuber%2CSubscriber%2C"><span class="Identifier">subscribe</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">subscriber</span><span class="Other">:</span> <a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a><span class="Other">;</span> <span class="Identifier">topic</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a> <span class="Operator">|</span> <span class="Identifier">int</span><span class="Other">;</span>
               <span class="Identifier">createnewtopic</span> <span class="Other">=</span> <span class="Identifier">false</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">discardable</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

Creates new subscription. If <tt class="docutils literal"><span class="pre">createnewtopic</span></tt> is false, the topic must already exist, otherwise it is added as needed.

</dd>
<a id="unsubscribe,Suber,Subscriber,Topic"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#unsubscribe%2CSuber%2CSubscriber%2CTopic"><span class="Identifier">unsubscribe</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">subscriber</span><span class="Other">:</span> <a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a><span class="Other">;</span> <span class="Identifier">topic</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a><span class="Other">)</span></pre></dt>
<dd>

Removes a subscription.

</dd>
<a id="removeSubscriber,Suber,Subscriber"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#removeSubscriber%2CSuber%2CSubscriber"><span class="Identifier">removeSubscriber</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">subscriber</span><span class="Other">:</span> <a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a><span class="Other">)</span></pre></dt>
<dd>

Removes all subscriptions of the subscriber.

</dd>
<a id="getSubscriptions,Suber,Subscriber"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#getSubscriptions%2CSuber%2CSubscriber"><span class="Identifier">getSubscriptions</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">subscriber</span><span class="Other">:</span> <a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">seq</span><span class="Other">[</span><a href="index.html#Topic"><span class="Identifier">Topic</span></a><span class="Other">]</span></pre></dt>
<dd>



</dd>
<a id="getSubscribers,Suber,"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#getSubscribers%2CSuber%2C"><span class="Identifier">getSubscribers</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">topic</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a> <span class="Operator">|</span> <span class="Identifier">int</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">IntSet</span></pre></dt>
<dd>



</dd>
<a id="getSubscribers,Suber"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#getSubscribers%2CSuber"><span class="Identifier">getSubscribers</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">IntSet</span></pre></dt>
<dd>



</dd>
<a id="getSubscribers,Suber,openArray[Topic]"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#getSubscribers%2CSuber%2CopenArray%5BTopic%5D"><span class="Identifier">getSubscribers</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">topics</span><span class="Other">:</span> <span class="Identifier">openArray</span><span class="Other">[</span><a href="index.html#Topic"><span class="Identifier">Topic</span></a><span class="Other">]</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">IntSet</span></pre></dt>
<dd>

Gets subscribers that are subscribing to any of the topics (set union).

</dd>
<a id="getSubscribers,Suber,ptr.SuberMessage,IntSet"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#getSubscribers%2CSuber%2Cptr.SuberMessage%2CIntSet"><span class="Identifier">getSubscribers</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">message</span><span class="Other">:</span> <span class="Keyword">ptr</span> <a href="index.html#SuberMessage"><span class="Identifier">SuberMessage</span></a><span class="Other">;</span> <span class="Identifier">toset</span><span class="Other">:</span> <span class="Keyword">var</span> <span class="Identifier">IntSet</span><span class="Other">;</span>
                    <span class="Identifier">clear</span> <span class="Other">=</span> <span class="Identifier">true</span><span class="Other">)</span></pre></dt>
<dd>

Gets subscribers to given message into the <tt class="docutils literal"><span class="pre">toset</span></tt> given as parameter. If <tt class="docutils literal"><span class="pre">clear</span></tt> is true, the <tt class="docutils literal"><span class="pre">toset</span></tt> is cleared first.

</dd>
<a id="isSubscriber,Suber,Subscriber,Topic"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#isSubscriber%2CSuber%2CSubscriber%2CTopic"><span class="Identifier">isSubscriber</span></a><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">subscriber</span><span class="Other">:</span> <a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a><span class="Other">;</span> <span class="Identifier">topic</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span></pre></dt>
<dd>



</dd>
<a id="doDelivery,Suber[TData,SuberMaxTopics]"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#doDelivery%2CSuber%5BTData%2CSuberMaxTopics%5D"><span class="Identifier">doDelivery</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">;</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">,</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">)</span></pre></dt>
<dd>

Call this to trigger a delivery (DeliverCallback). To achieve time-based delivery, call this on regular intervals.

</dd>
<a id="push,Suber,sinkIntSet,sinkTData,int"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#push%2CSuber%2CsinkIntSet%2CsinkTData%2Cint"><span class="Identifier">push</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">topics</span><span class="Other">:</span> <span class="Identifier">sink</span> <span class="Identifier">IntSet</span><span class="Other">;</span> <span class="Identifier">data</span><span class="Other">:</span> <span class="Identifier">sink</span> <span class="Identifier">TData</span><span class="Other">;</span>
                 <span class="Identifier">size</span><span class="Other">:</span> <span class="Identifier">int</span> <span class="Other">=</span> <span class="DecNumber">0</span><span class="Other">)</span></pre></dt>
<dd>

Pushes new message to message cache to be delivered.<p><tt class="docutils literal"><span class="pre">suber</span></tt>: the service<br /><tt class="docutils literal"><span class="pre">topics</span></tt>: set of topics that this message belongs to<br /><tt class="docutils literal"><span class="pre">data</span></tt>: message payload. Available later as the data field of SuberMessage<br /><tt class="docutils literal"><span class="pre">size</span></tt>: Size of the data. Required only when size-based delivery is being used.<br /></p>

</dd>
<a id="push,Suber,,sinkTData,int"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#push%2CSuber%2C%2CsinkTData%2Cint"><span class="Identifier">push</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">topic</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a> <span class="Operator">|</span> <span class="Identifier">int</span><span class="Other">;</span> <span class="Identifier">data</span><span class="Other">:</span> <span class="Identifier">sink</span> <span class="Identifier">TData</span><span class="Other">;</span>
                 <span class="Identifier">size</span><span class="Other">:</span> <span class="Identifier">int</span> <span class="Other">=</span> <span class="DecNumber">0</span><span class="Other">)</span></pre></dt>
<dd>



</dd>
<a id="pull,Suber[TData,SuberMaxTopics],,sinkIntSet,sinkMonoTime"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#pull%2CSuber%5BTData%2CSuberMaxTopics%5D%2C%2CsinkIntSet%2CsinkMonoTime"><span class="Identifier">pull</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">;</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">,</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">;</span>
                                 <span class="Identifier">subscriber</span><span class="Other">:</span> <a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a> <span class="Operator">|</span> <span class="Identifier">int</span><span class="Other">;</span>
                                 <span class="Identifier">topics</span><span class="Other">:</span> <span class="Identifier">sink</span> <span class="Identifier">IntSet</span><span class="Other">;</span>
                                 <span class="Identifier">aftertimestamp</span><span class="Other">:</span> <span class="Identifier">sink</span> <span class="Identifier">MonoTime</span><span class="Other">)</span></pre></dt>
<dd>

Requests messages after given timestamp and belonging to certain topics.<p><tt class="docutils literal"><span class="pre">suber</span></tt>: service<br /><tt class="docutils literal"><span class="pre">subscriber</span></tt>: will be passed to callback<br /><tt class="docutils literal"><span class="pre">topics</span></tt>: set of topics that are of interest<br /><tt class="docutils literal"><span class="pre">aftertimestamp</span></tt>: only messages published after this timestamp will be pulled<br /></p>

</dd>
<a id="pull,Suber[TData,SuberMaxTopics],,,sinkMonoTime"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#pull%2CSuber%5BTData%2CSuberMaxTopics%5D%2C%2C%2CsinkMonoTime"><span class="Identifier">pull</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">;</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">,</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">;</span>
                                 <span class="Identifier">subscriber</span><span class="Other">:</span> <a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a> <span class="Operator">|</span> <span class="Identifier">int</span><span class="Other">;</span>
                                 <span class="Identifier">topic</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a> <span class="Operator">|</span> <span class="Identifier">int</span><span class="Other">;</span>
                                 <span class="Identifier">aftertimestamp</span><span class="Other">:</span> <span class="Identifier">sink</span> <span class="Identifier">MonoTime</span><span class="Other">)</span></pre></dt>
<dd>



</dd>
<a id="pullAll,Suber[TData,SuberMaxTopics],,,sinkMonoTime"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#pullAll%2CSuber%5BTData%2CSuberMaxTopics%5D%2C%2C%2CsinkMonoTime"><span class="Identifier">pullAll</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">;</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">,</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">;</span>
                                    <span class="Identifier">subscriber</span><span class="Other">:</span> <a href="index.html#Subscriber"><span class="Identifier">Subscriber</span></a> <span class="Operator">|</span> <span class="Identifier">int</span><span class="Other">;</span>
                                    <span class="Identifier">topic</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a> <span class="Operator">|</span> <span class="Identifier">int</span><span class="Other">;</span>
                                    <span class="Identifier">aftertimestamp</span><span class="Other">:</span> <span class="Identifier">sink</span> <span class="Identifier">MonoTime</span><span class="Other">)</span></pre></dt>
<dd>



</dd>
<a id="find,Suber,MonoTime,proc(MonoTime,ptr.SuberMessage[TData])"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#find%2CSuber%2CMonoTime%2Cproc%28MonoTime%2Cptr.SuberMessage%5BTData%5D%29"><span class="Identifier">find</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">;</span> <span class="Identifier">query</span><span class="Other">:</span> <span class="Identifier">MonoTime</span><span class="Other">;</span> <span class="Identifier">callback</span><span class="Other">:</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Identifier">query</span><span class="Other">:</span> <span class="Identifier">MonoTime</span><span class="Other">;</span>
    <span class="Identifier">message</span><span class="Other">:</span> <span class="Keyword">ptr</span> <a href="index.html#SuberMessage"><span class="Identifier">SuberMessage</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">]</span><span class="Other">)</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">gcsafe</span><span class="Other">,</span> <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span><span class="Other">)</span></pre></dt>
<dd>

<p>Calls the <tt class="docutils literal"><span class="pre">callback</span></tt> with (pointer to) the <tt class="docutils literal"><span class="pre">message</span></tt> that has the timestamp given in <tt class="docutils literal"><span class="pre">query</span></tt>.</p>
<p><strong>Important</strong>: If queried message is not cached, message will be <tt class="docutils literal"><span class="pre">nil</span></tt>. Always check for <tt class="docutils literal"><span class="pre">nil</span></tt> first.</p>
<p>Note that callback must be gcsafe and not raise any exceptions.</p>


</dd>
<a id="doSynced,Suber[TData,SuberMaxTopics],proc)"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#doSynced%2CSuber%5BTData%2CSuberMaxTopics%5D%2Cproc%29"><span class="Identifier">doSynced</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">;</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">suber</span><span class="Other">:</span> <a href="index.html#Suber"><span class="Identifier">Suber</span></a><span class="Other">[</span><span class="Identifier">TData</span><span class="Other">,</span> <span class="Identifier">SuberMaxTopics</span><span class="Other">]</span><span class="Other">;</span>
                                     <span class="Identifier">callback</span><span class="Other">:</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Other">)</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">gcsafe</span><span class="Other">,</span> <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span><span class="Other">)</span></pre></dt>
<dd>

<p>Calls the <tt class="docutils literal"><span class="pre">callback</span></tt> so that no other callbacks (delivery, etc.) are not being processed in parallel</p>
<p>Note that callback must be gcsafe and not raise any exceptions.</p>


</dd>

</dl></div>
<div class="section" id="16">
<h1><a class="toc-backref" href="#16">Converters</a></h1>
<dl class="item">
<a id="toTopic.c,int"></a>
<dt><pre><span class="Keyword">converter</span> <a href="#toTopic.c%2Cint"><span class="Identifier">toTopic</span></a><span class="Other">(</span><span class="Identifier">x</span><span class="Other">:</span> <span class="Identifier">int</span><span class="Other">)</span><span class="Other">:</span> <a href="index.html#Topic"><span class="Identifier">Topic</span></a> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>



</dd>

</dl></div>

  </div>
</div>

    <div class="row">
      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br/>
        <small style="color: var(--hint);">Made with Nim. Generated: 2021-08-09 13:32:43 UTC</small>
      </div>
    </div>
  </div>
</div>

</body>
</html>
